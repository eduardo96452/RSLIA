<main>
    <div>
        <div [ngClass]="{
            'px-5': isLargeScreen,
            'container': !isLargeScreen
          }">
            <div class="row align-items-start">
                <div class="col-md-12">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <div class="row">
                                <div>
                                    <li class="breadcrumb-item" aria-current="page">
                                        {{reviewData.titulo_revision}}</li>
                                </div>
                            </div>
                        </ol>
                    </nav>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col-12 col-md-2">
                    <div class="d-flex">
                        <div class="floating-menu">
                            <!-- Descripción general -->
                            <div class="menu-item" [routerLink]="['/detalle_revision']"
                                [queryParams]="{ id: reviewId }">
                                Descripción general
                            </div>
                            <!-- Planificación -->
                            <div class="menu-item active" [routerLink]="['/planificacion']"
                                [queryParams]="{ id: reviewId }">
                                Planificación
                            </div>
                            <!-- Revisión de datos -->
                            <div class="menu-item" [routerLink]="['/estudios']" [queryParams]="{ id: reviewId }">
                                Revisión de datos
                            </div>
                            <!-- Extracción de datos -->
                            <div class="menu-item" [routerLink]="['/extraccion_datos']"
                                [queryParams]="{ id: reviewId }">
                                Extracción de datos
                            </div>
                            <!-- Proyección de borrador de artículo -->
                            <div class="menu-item" [routerLink]="['/informes']" [queryParams]="{ id: reviewId }">
                                Redacción de articulo
                            </div>
                            <!-- Diagrama de Flujo PRISMA -->
                            <div class="menu-item" [routerLink]="['/prisma']" [queryParams]="{ id: reviewId }">
                                Diagrama de Flujo PRISMA
                            </div>
                        </div>
                    </div>
                    <br />
                </div>

                <div class="col col-sm col-md-10">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                <!-- Página 1 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active protocolo-tab" id="tab1" data-bs-toggle="tab"
                                        data-bs-target="#pagina1" type="button" role="tab" aria-controls="pagina1"
                                        aria-selected="true">
                                        Protocolo
                                    </button>
                                </li>

                                <!-- Página 2 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tab2" data-bs-toggle="tab" data-bs-target="#pagina2"
                                        type="button" role="tab" aria-controls="pagina2" aria-selected="false">
                                        <span class="d-none d-sm-inline">Verificación de calidad</span>
                                        <span class="d-inline d-sm-none">verificación de calidad</span>
                                    </button>
                                </li>

                                <!-- Página 3 -->
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tab2" data-bs-toggle="tab" data-bs-target="#pagina3"
                                        type="button" role="tab" aria-controls="pagina3" aria-selected="false">
                                        <span class="d-none d-sm-inline">Formulario de extracción de datos</span>
                                        <span class="d-inline d-sm-none">Formulario de extracción de datos</span>
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="container">
                                <!-- Contenido de las páginas -->
                                <div class="tab-content" id="myTabContent">
                                    <!-- Contenido Página 1 -->
                                    <div class="tab-pane fade show active" id="pagina1" role="tabpanel"
                                        aria-labelledby="tab1">

                                        <p>Aquí encontrarás los pasos esenciales para avanzar con tu revisión
                                            sistemática
                                            de literatura y asegurar resultados de calidad:</p>

                                        <div class="accordion accordion-flush" id="accordionFlushExample">

                                            <!-- Acordeon de Objetivo-->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button d-flex align-items-center collapsed"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseOne" aria-expanded="false"
                                                        aria-controls="flush-collapseOne"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <!-- Contenedor flex para título + tooltip -->
                                                        <div class="d-flex align-items-center w-100">
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <ng-container *ngIf="!objectiveSaved; else iconCheck">
                                                                    <i class="fa-solid fa-pencil me-2"></i>
                                                                    1.&nbsp;- Objetivo de la revisión
                                                                </ng-container>
                                                                <ng-template #iconCheck>
                                                                    <i class="fa-solid fa-pencil me-2"></i>
                                                                    1.&nbsp;- Objetivo de la revisión&nbsp;&nbsp;
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </ng-template>
                                                            </h5>

                                                            <!-- Tooltip junto al título -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showObjectiveHelp = true"
                                                                (mouseleave)="showObjectiveHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showObjectiveHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí debes definir el objetivo principal de tu
                                                                        revisión. Describe en una
                                                                        sola oración qué quieres alcanzar con este
                                                                        estudio sistemático.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>

                                                <div id="flush-collapseOne" class="accordion-collapse collapse"
                                                    aria-labelledby="flush-headingOne"
                                                    data-bs-parent="#accordionFlushExample">
                                                    <div class="accordion-body">
                                                        <!-- Contenedor principal -->
                                                        <div class="d-flex justify-content-end">
                                                            <!-- Botón de Sugerencia IA en la fila superior -->

                                                            <button class="btn btn-info align-self-start" type="button"
                                                                (click)="getIaSuggestion()"
                                                                onclick="event.stopPropagation();">
                                                                <i class="bi bi-robot"></i>&nbsp; Generar objetivo
                                                                con IA
                                                            </button>
                                                        </div>
                                                        <!-- Contenido principal debajo, en una nueva fila -->
                                                        <div class="mt-3">
                                                            <form>
                                                                <!-- Contenedor relativo para el textarea y el botón flotante -->
                                                                <!-- Contenedor relativo para el textarea y el botón flotante -->
                                                                <div class="position-relative textarea-container mb-3">
                                                                    <!-- Botón flotante en la parte superior derecha -->
                                                                    <button
                                                                        class="btn btn-secondary btn-sm floating-copy-btn"
                                                                        type="button" (click)="copyObjective()">
                                                                        <i class="bi bi-clipboard"></i>&nbsp;
                                                                        {{ isCopied ? 'Copiado' : 'Copiar' }}
                                                                    </button>

                                                                    <!-- Textarea con padding para que el texto no quede detrás del botón -->
                                                                    <textarea class="form-control" id="description"
                                                                        rows="5" [(ngModel)]="objetivo" name="objetivo"
                                                                        maxlength="1000"
                                                                        placeholder="Ingrese un objetivo para la reseña"
                                                                        (ngModelChange)="onTextChange($event)"></textarea>
                                                                </div>

                                                                <!-- Indicador de caracteres -->
                                                                <div class="text-end text-muted mt-1">
                                                                    <small>{{ charCount }}/800 caracteres</small>
                                                                </div>
                                                            </form>
                                                            <div class="row mt-2">
                                                                <div class="col-auto">
                                                                    <!-- Botón para limpiar -->
                                                                    <button class="btn btn-secondary" type="button"
                                                                        (click)="clearObjetivo()">
                                                                        <i class="fa-solid fa-eraser"></i>&nbsp; Limpiar
                                                                    </button>
                                                                </div>
                                                                <!-- Botón de guardar SOLO aparece si !objectiveSaved -->
                                                                <div class="col text-end" *ngIf="!objectiveSaved">
                                                                    <button class="btn btn-success" type="button"
                                                                        (click)="saveObjective()">
                                                                        <i class="fa-solid fa-paper-plane"></i> &nbsp;
                                                                        Guardar objetivo
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de pregunta de investigación -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseThree" aria-expanded="false"
                                                        aria-controls="flush-collapseThree"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-question-circle me-2"></i>
                                                                2.- Preguntas de investigación
                                                                <span *ngIf="questionsUpdated" class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showQuestionsHelp = true"
                                                                (mouseleave)="showQuestionsHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showQuestionsHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí debes redactar una o varias preguntas que
                                                                        guiarán tu revisión. Cada pregunta debe reflejar
                                                                        un aspecto clave que deseas investigar.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>

                                                <div id="flush-collapseThree" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample">

                                                    <div class="accordion-body">
                                                        <div class="d-flex justify-content-between">
                                                            <!-- Botón Agregar pregunta alineado a la derecha -->
                                                            <button class="btn btn-primary btn-sm"
                                                                (click)="addQuestion()">
                                                                <i class="bi bi-plus"></i>&nbsp; Agregar pregunta
                                                            </button>

                                                            <!-- Botón Sugerencia IA alineado a la izquierda -->
                                                            <button class="btn btn-info" type="button"
                                                                (click)="generateResearchQuestions()">
                                                                <i class="bi bi-robot"></i>&nbsp; Generar
                                                                pregunta
                                                                con IA
                                                            </button>
                                                        </div>
                                                        <br>

                                                        <div class="container">
                                                            <p>Tipo de Investigación:
                                                                <strong>{{reviewData.tipo_investigacion}}</strong>
                                                            </p>
                                                            <div *ngFor="let question of questions" class="mb-3">
                                                                <div class="input-group mb-2">
                                                                    <textarea class="form-control"
                                                                        [(ngModel)]="question.value"
                                                                        [disabled]="!!question.isSaved"
                                                                        placeholder="Escriba su pregunta de investigación">
                                                                    </textarea>
                                                                    <button
                                                                        *ngIf="!question.isSaved && !question.isEditing"
                                                                        class="btn btn-outline-danger" type="button"
                                                                        (click)="cancelQuestion(question.id)">
                                                                        <i class="bi bi-x"></i>
                                                                    </button>
                                                                </div>
                                                                <div class="d-flex justify-content-end gap-2">
                                                                    <!-- Si la pregunta no está guardada y NO está en modo edición, se muestra "Guardar" -->
                                                                    <button
                                                                        *ngIf="!question.isSaved && !question.isEditing"
                                                                        class="btn btn-success"
                                                                        (click)="saveQuestion(question)">
                                                                        <i class="bi bi-floppy"></i> Guardar
                                                                    </button>
                                                                    <!-- Si la pregunta ya está guardada y NO está en modo edición, se muestran "Editar" y "Eliminar" -->
                                                                    <button
                                                                        *ngIf="question.isSaved && !question.isEditing"
                                                                        class="btn btn-warning"
                                                                        (click)="editQuestion(question)">
                                                                        <i class="bi bi-pencil"></i> Editar
                                                                    </button>
                                                                    <button *ngIf="question.isEditing"
                                                                        class="btn btn-success"
                                                                        (click)="updateQuestion(question)">
                                                                        <i class="bi bi-check"></i> Actualizar
                                                                    </button>
                                                                    <button
                                                                        *ngIf="question.isSaved && !question.isEditing"
                                                                        class="btn btn-danger"
                                                                        (click)="deleteQuestion(question.id)">
                                                                        <i class="bi bi-trash"></i> Eliminar
                                                                    </button>
                                                                    <button
                                                                        *ngIf="!question.isSaved && question.isEditing"
                                                                        class="btn btn-danger"
                                                                        (click)="deleteQuestion(question.id)">
                                                                        <i class="bi bi-trash"></i> Eliminar
                                                                    </button>

                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de framework -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseTwo" aria-expanded="false"
                                                        aria-controls="flush-collapseTwo"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-book-half me-2"></i>
                                                                3.- Selecciona un Framework
                                                                <ng-container *ngIf="metodologiaGuardada">
                                                                    &nbsp;&nbsp;<i
                                                                        class="bi bi-check-circle-fill text-success"></i>
                                                                </ng-container>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showFrameworkHelp = true"
                                                                (mouseleave)="showFrameworkHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showFrameworkHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí eliges la estructura de revisión que
                                                                        seguirás (PICO, PICOC, PICOTT, SPICE…).
                                                                        Selecciona el modelo que mejor se adapte a tu
                                                                        pregunta de investigación.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>

                                                <div id="flush-collapseTwo" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample">
                                                    <div class="accordion-body">
                                                        <select class="form-select mb-4" id="paginaSelect"
                                                            [(ngModel)]="paginaSeleccionada"
                                                            (ngModelChange)="onMetodoChange($event)">
                                                            <option *ngFor="let metodo of metodologias"
                                                                [value]="metodo.nombre">
                                                                {{ metodo.nombre }}
                                                            </option>
                                                        </select>
                                                        <div class="">
                                                            <!-- PICO -->
                                                            <div class="card p-3" *ngIf="paginaSeleccionada === 'PICO'">
                                                                <div class="container">
                                                                    <div class="row align-items-start">
                                                                        <div class="col">
                                                                            <h5 class="fw-bold">PICO</h5>
                                                                        </div>
                                                                        <div class="col text-end">
                                                                            <button class="btn btn-info" type="button"
                                                                                (click)="generateMethodologyStructure()">
                                                                                <i class="bi bi-robot"></i> &nbsp;
                                                                                Generar {{paginaSeleccionada}} con IA
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <br />
                                                                    <div class="row">
                                                                        <div class="col">
                                                                            <form>
                                                                                <div
                                                                                    *ngIf="paginaSeleccionada.toUpperCase() === 'PICO'">
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Población
                                                                                            (P)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picoP"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picoP" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Intervención
                                                                                            (I)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picoI"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picoI" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Comparación
                                                                                            (C)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picoC"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picoC" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Resultado
                                                                                            (O)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picoO"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picoO" />
                                                                                    </div>
                                                                                </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="card-footer text-end"
                                                                    *ngIf="!metodologiaGuardada">
                                                                    <button class="btn btn-success" type="button"
                                                                        (click)="guardarMetodologia()">
                                                                        <i class="fa-solid fa-paper-plane"></i> &nbsp;
                                                                        Guardar metodología PICO
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <!-- PICOC -->
                                                            <div class="card p-3"
                                                                *ngIf="paginaSeleccionada === 'PICOC'">
                                                                <div class="container">
                                                                    <div class="row align-items-start">
                                                                        <div class="col">
                                                                            <h5 class="fw-bold">PICOC</h5>
                                                                        </div>
                                                                        <div class="col text-end">
                                                                            <button class="btn btn-info" type="button"
                                                                                (click)="generateMethodologyStructure()">
                                                                                <i class="bi bi-robot"></i>
                                                                                &nbsp; Generar {{paginaSeleccionada}}
                                                                                con IA
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <br />
                                                                    <div class="row">
                                                                        <div class="col">
                                                                            <form>
                                                                                <div
                                                                                    *ngIf="paginaSeleccionada.toUpperCase() === 'PICOC'">
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Población
                                                                                            (P)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picocP"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picocP" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Intervención
                                                                                            (I)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picocI"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picocI" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Comparación
                                                                                            (C)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picocC"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picocC" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Resultado
                                                                                            (O)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picocO"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picocO" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Contexto
                                                                                            (C)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picocContext"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picocContext" />
                                                                                    </div>
                                                                                </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="card-footer text-end"
                                                                    *ngIf="!metodologiaGuardada">
                                                                    <button class="btn btn-success" type="button"
                                                                        (click)="guardarMetodologia()">
                                                                        <i class="fa-solid fa-paper-plane"></i> &nbsp;
                                                                        Guardar metodología PICOC
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <!-- PICOTT -->
                                                            <div class="card p-3"
                                                                *ngIf="paginaSeleccionada === 'PICOTT'">
                                                                <div class="container">
                                                                    <div class="row align-items-start">
                                                                        <div class="col">
                                                                            <h5 class="fw-bold">PICOTT</h5>
                                                                        </div>
                                                                        <div class="col text-end">
                                                                            <button class="btn btn-info" type="button"
                                                                                (click)="generateMethodologyStructure()">
                                                                                <i class="bi bi-robot"></i>
                                                                                &nbsp; Generar {{paginaSeleccionada}}
                                                                                con IA
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <br />
                                                                    <div class="row">
                                                                        <div class="col">
                                                                            <form>
                                                                                <div
                                                                                    *ngIf="paginaSeleccionada.toUpperCase() === 'PICOTT'">
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Población
                                                                                            (P)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picottP"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picottP" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Intervención
                                                                                            (I)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picottI"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picottI" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Comparación
                                                                                            (C)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picottC"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picottC" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Resultado
                                                                                            (O)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picottO"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picottO" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label class="form-label">Tipo
                                                                                            de
                                                                                            pregunta (T)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picottT"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picottT" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label class="form-label">Tipo
                                                                                            de
                                                                                            estudio (T)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="picottT2"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="picottT2" />
                                                                                    </div>
                                                                                </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="card-footer text-end"
                                                                    *ngIf="!metodologiaGuardada">
                                                                    <button class="btn btn-success" type="button"
                                                                        (click)="guardarMetodologia()">
                                                                        <i class="fa-solid fa-paper-plane"></i> &nbsp;
                                                                        Guardar metodología PICOTT
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <!-- SPICE -->
                                                            <div class="card p-3"
                                                                *ngIf="paginaSeleccionada === 'SPICE'">
                                                                <div class="container">
                                                                    <div class="row align-items-start">
                                                                        <div class="col">
                                                                            <h5 class="fw-bold">SPICE</h5>
                                                                        </div>
                                                                        <div class="col text-end">
                                                                            <button class="btn btn-info" type="button"
                                                                                (click)="generateMethodologyStructure()">
                                                                                <i class="bi bi-robot"></i>
                                                                                &nbsp; Generar {{paginaSeleccionada}}
                                                                                con IA
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <br />
                                                                    <div class="row">
                                                                        <div class="col">
                                                                            <form>
                                                                                <div
                                                                                    *ngIf="paginaSeleccionada.toUpperCase() === 'SPICE'">
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Escenario
                                                                                            (E)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="spiceS"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="spiceS" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Perspectiva
                                                                                            (P)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="spiceP"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="spiceP" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Intervención
                                                                                            (I)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="spiceI"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="spiceI" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Comparación
                                                                                            (C)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="spiceC"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="spiceC" />
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label
                                                                                            class="form-label">Evaluación
                                                                                            (E)</label>
                                                                                        <input type="text"
                                                                                            class="form-control"
                                                                                            [(ngModel)]="spiceE"
                                                                                            (ngModelChange)="onInputChanged()"
                                                                                            name="spiceE" />
                                                                                    </div>
                                                                                </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="card-footer text-end"
                                                                    *ngIf="!metodologiaGuardada">
                                                                    <button class="btn btn-success" type="button"
                                                                        (click)="guardarMetodologia()">
                                                                        <i class="fa-solid fa-paper-plane"></i> &nbsp;
                                                                        Guardar metodología SPICE
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de Términos claves y sinónimos -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseFour" aria-expanded="false"
                                                        aria-controls="flush-collapseFour"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-key-fill me-2"></i>
                                                                4.- Términos claves y sinónimos
                                                                <span *ngIf="keywordsUpdated" class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showKeywordsHelp = true"
                                                                (mouseleave)="showKeywordsHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showKeywordsHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí defines los términos clave que guiarán tu
                                                                        búsqueda y agregas sinónimos relevantes para
                                                                        ampliar la cobertura en las bases de datos.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>
                                                <div id="flush-collapseFour" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample">
                                                    <div class="accordion-body">
                                                        <div class="d-flex justify-content-between">
                                                            <!-- Botón Agregar Termino clave alineado a la derecha -->
                                                            <button class="btn btn-primary" data-bs-toggle="modal"
                                                                (click)="addRow()" data-bs-target="#staticBackdrop"><i
                                                                    class="bi bi-plus"></i>
                                                                &nbsp;
                                                                Añadir termino clave
                                                            </button>
                                                            <!-- Botón Sugerencia IA alineado a la izquierda -->
                                                            <button class="btn btn-info" type="button"
                                                                (click)="generateKeywords()">
                                                                <i class="bi bi-robot"></i>&nbsp; Generar sinonimos
                                                                con IA
                                                            </button>
                                                        </div>
                                                        <br>
                                                        <div class="table-responsive">
                                                            <table class="table table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="display:none;">ID</th>
                                                                        <th class="text-center">Termino clave</th>
                                                                        <th class="text-center">Componente</th>
                                                                        <th style="display:none;">ID_sinonimos</th>
                                                                        <th class="text-center">Sinónimos</th>
                                                                        <th class="text-center">Acciones</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr *ngFor="let row of tableData; let i = index">
                                                                        <!-- Columna oculta para ID -->
                                                                        <td style="display:none;">{{
                                                                            row.id_palabras_clave }}</td>

                                                                        <!-- Palabra Clave -->
                                                                        <td>
                                                                            <textarea class="form-control" type="text"
                                                                                [(ngModel)]="row.keyword"
                                                                                [readonly]="!row.isEditing">
                                                                            </textarea>
                                                                        </td>

                                                                        <!-- Componente (Relacionado) -->
                                                                        <td>
                                                                            <select class="form-select"
                                                                                [(ngModel)]="row.related"
                                                                                [disabled]="!row.isEditing"
                                                                                (ngModelChange)="onRelatedChange($event)"
                                                                                [compareWith]="compareFn">
                                                                                <!-- Opción por defecto que se muestra pero no se puede seleccionar -->
                                                                                <option [ngValue]="defaultRelatedOption"
                                                                                    disabled>Elije un componente
                                                                                </option>
                                                                                <!-- Opciones cargadas dinámicamente -->
                                                                                <option
                                                                                    *ngFor="let option of relatedOptions"
                                                                                    [ngValue]="option">
                                                                                    {{ option.nombre }}
                                                                                </option>
                                                                            </select>
                                                                        </td>

                                                                        <!-- Columna oculta para ID -->
                                                                        <td style="display:none;">{{
                                                                            row.id_sinonimos }}</td>

                                                                        <!-- Sinónimos -->
                                                                        <td>
                                                                            <!-- Itera sobre el arreglo de sinónimos usando trackBy para conservar el foco -->
                                                                            <div *ngFor="let synonym of row.synonyms; let j = index; trackBy: trackByIndex"
                                                                                class="d-flex align-items-center">
                                                                                <input class="form-control mb-1"
                                                                                    type="text"
                                                                                    [(ngModel)]="row.synonyms[j]"
                                                                                    [readonly]="!row.isEditing"
                                                                                    placeholder="Sinónimo {{ j + 1 }}"
                                                                                    (keypress)="preventSpecialChars($event)" />
                                                                                <!-- Botón para eliminar este sinónimo (solo en modo edición) -->
                                                                                <button *ngIf="row.isEditing"
                                                                                    type="button"
                                                                                    class="btn btn-outline-danger btn-sm ms-1"
                                                                                    (click)="removeSynonym(row, j)">
                                                                                    <i class="bi bi-x"></i>
                                                                                </button>
                                                                            </div>
                                                                            <!-- Botón para añadir un nuevo sinónimo, visible solo en modo edición -->
                                                                            <button *ngIf="row.isEditing" type="button"
                                                                                class="btn btn-sm btn-primary"
                                                                                (click)="addSynonym(row)">
                                                                                <i class="bi bi-plus"></i> Añadir
                                                                                sinónimo
                                                                            </button>
                                                                        </td>

                                                                        <!-- Acciones -->
                                                                        <td class="text-center">
                                                                            <!-- Caso: registro nuevo (sin id) -->
                                                                            <button *ngIf="!row.id_palabras_clave"
                                                                                class="btn btn-success btn-sm me-1"
                                                                                [disabled]="!row.isEditing"
                                                                                (click)="saveSynonymAndKeyword(row)">
                                                                                Guardar
                                                                            </button>
                                                                            <!-- Caso: registro existente -->
                                                                            <ng-container *ngIf="row.id_palabras_clave">
                                                                                <button *ngIf="!row.isEditing"
                                                                                    class="btn btn-warning btn-sm me-1"
                                                                                    (click)="editRow(i)">
                                                                                    Editar
                                                                                </button>
                                                                                <button *ngIf="row.isEditing"
                                                                                    class="btn btn-success btn-sm me-1"
                                                                                    (click)="updateSynonymAndKeyword(row)">
                                                                                    <i class="fa-solid fa-save"></i>
                                                                                    Actualizar
                                                                                </button>
                                                                            </ng-container>
                                                                            <!-- Botón para eliminar -->
                                                                            <button class="btn btn-danger btn-sm"
                                                                                (click)="deleteRow(i)">
                                                                                Eliminar
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de Gestión de Bases Bibliográficas -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseSix" aria-expanded="false"
                                                        aria-controls="flush-collapseSix"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-clipboard-data-fill me-2"></i>
                                                                5.- Gestión de Bases Bibliográficas
                                                                <span *ngIf="basesGuardadas" class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showBasesHelp = true"
                                                                (mouseleave)="showBasesHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showBasesHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí puedes añadir, editar o eliminar las bases
                                                                        de datos que consultará tu revisión; asegúrate
                                                                        de incluir nombre y URL de cada fuente.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>

                                                <div id="flush-collapseSix" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample">
                                                    <div class="accordion-body">
                                                        <div class="d-flex justify-content-between">
                                                            <!-- Botón Agregar alineado a la derecha -->
                                                            <button class="btn btn-primary me-2" (click)="addBase()">+
                                                                Agregar Base bibliografica</button>
                                                            <!-- Botón Sugerencia alineado a la izquierda -->
                                                            <button class="btn btn-info"
                                                                (click)="showSuggestions()">Sugerir Bases
                                                                bibliografica</button>
                                                        </div>
                                                        <!-- Contenido principal debajo, en una nueva fila -->
                                                        <div class="mt-3">
                                                            <table class="table table-bordered">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width: 30%;">Nombre</th>
                                                                        <th style="width: 50%;">URL</th>
                                                                        <th style="width: 20%;">Acciones</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    <tr *ngFor="let base of bases; let i = index">
                                                                        <!-- Columna Nombre -->
                                                                        <td>
                                                                            <ng-container
                                                                                *ngIf="base.isEditing; else viewName">
                                                                                <input type="text" class="form-control"
                                                                                    [(ngModel)]="base.nombre"
                                                                                    placeholder="Nombre de la base" />
                                                                            </ng-container>
                                                                            <ng-template #viewName>
                                                                                {{ base.nombre }}
                                                                            </ng-template>
                                                                        </td>

                                                                        <!-- Columna URL -->
                                                                        <td>
                                                                            <ng-container
                                                                                *ngIf="base.isEditing; else viewUrl">
                                                                                <input type="text" class="form-control"
                                                                                    [(ngModel)]="base.url"
                                                                                    placeholder="URL" />
                                                                            </ng-container>
                                                                            <ng-template #viewUrl>
                                                                                <a [href]="base.url" target="_blank">{{
                                                                                    base.url }}</a>
                                                                            </ng-template>
                                                                        </td>

                                                                        <!-- Columna Acciones -->
                                                                        <td>
                                                                            <!-- Modo edición -->
                                                                            <ng-container
                                                                                *ngIf="base.isEditing; else normalActions">
                                                                                <button
                                                                                    class="btn btn-success btn-sm me-1"
                                                                                    (click)="saveBase(i)">Guardar</button>
                                                                                <button class="btn btn-secondary btn-sm"
                                                                                    (click)="cancelEdit1(i)">Cancelar</button>
                                                                            </ng-container>

                                                                            <!-- Modo vista -->
                                                                            <ng-template #normalActions>
                                                                                <button
                                                                                    class="btn btn-warning btn-sm me-1"
                                                                                    (click)="editBase(i)">Editar</button>
                                                                                <button class="btn btn-danger btn-sm"
                                                                                    (click)="removeBase(i)">Eliminar</button>
                                                                            </ng-template>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de Cadena de búsqueda -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseFive" aria-expanded="false"
                                                        aria-controls="flush-collapseFive"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y estado -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-stack-overflow me-2"></i>
                                                                6.- Cadena de búsqueda
                                                                <span *ngIf="allCadenasComplete; else warningIcon"
                                                                    class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                                <ng-template #warningIcon>
                                                                    <i
                                                                        class="bi bi-exclamation-triangle-fill text-warning ms-2"></i>
                                                                </ng-template>
                                                            </h5>

                                                            <!-- Tooltip de ayuda junto al título -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showSearchHelp = true"
                                                                (mouseleave)="showSearchHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showSearchHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí defines tu cadena de búsqueda global y las
                                                                        alternativas por base; combina términos,
                                                                        operadores booleanos y sinónimos para optimizar
                                                                        tus resultados.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>
                                                <div id="flush-collapseFive" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample">
                                                    <div class="accordion-body">
                                                        <!-- Botón de Sugerencia IA global (opcional) -->
                                                        <div class="d-flex justify-content-end mb-3">
                                                            <button class="btn btn-info" type="button"
                                                                (click)="generateSearchString()">
                                                                <i class="bi bi-robot"></i>&nbsp; Generar cadena con IA
                                                            </button>
                                                        </div>

                                                        <!-- Bloque para Cadena Global -->
                                                        <div class="mb-4 border p-2 rounded">
                                                            <h6 class="mb-2">Global</h6>
                                                            <form>
                                                                <div class="position-relative textarea-container">
                                                                    <button
                                                                        class="btn btn-secondary btn-sm floating-copy-btn"
                                                                        type="button" (click)="copyGlobalCadena()">
                                                                        <i class="bi bi-clipboard"></i>&nbsp;
                                                                        {{ isGlobalCadenaCopied ? 'Copiado' : 'Copiar'
                                                                        }}
                                                                    </button>

                                                                    <textarea class="form-control" rows="3"
                                                                        [(ngModel)]="globalCadena" name="globalCadena"
                                                                        placeholder="Ingrese la cadena de búsqueda global"
                                                                        maxlength="1200"
                                                                        (ngModelChange)="globalCadenaGuardada = false"></textarea>
                                                                </div>

                                                                <div class="row mt-2">
                                                                    <div class="col-auto">
                                                                        <!-- Ahora llama al método que limpia y resetea el flag -->
                                                                        <button class="btn btn-secondary me-2"
                                                                            type="button" (click)="clearGlobalCadena()">
                                                                            <i class="fa-solid fa-eraser"></i>&nbsp;
                                                                            Limpiar
                                                                        </button>
                                                                    </div>
                                                                    <div class="col text-end">
                                                                        <!-- Este botón reaparecerá tras limpiar -->
                                                                        <button class="btn btn-success" type="button"
                                                                            *ngIf="!globalCadenaGuardada"
                                                                            (click)="saveGlobalCadena()">
                                                                            <i
                                                                                class="fa-solid fa-paper-plane"></i>&nbsp;
                                                                            Guardar cadena global
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>

                                                        <!-- Bloque para cada Base Bibliográfica -->
                                                        <div *ngFor="let base of bases; let i = index"
                                                            class="mb-4 border p-2 rounded">
                                                            <h6 class="mb-2">{{ base.nombre }}</h6>
                                                            <form>
                                                                <div class="position-relative textarea-container">
                                                                    <button
                                                                        class="btn btn-secondary btn-sm floating-copy-btn"
                                                                        type="button" (click)="copyCadenaForBase(base)">
                                                                        <i class="bi bi-clipboard"></i>&nbsp;
                                                                        {{ base.isCadenaCopied ? 'Copiado' : 'Copiar' }}
                                                                    </button>

                                                                    <textarea class="form-control" rows="3"
                                                                        [(ngModel)]="base.cadenaBusqueda"
                                                                        name="cadenaBusqueda{{i}}"
                                                                        placeholder="Ingrese la cadena de búsqueda para {{ base.nombre }}"
                                                                        maxlength="1200"
                                                                        (ngModelChange)="base.cadenaGuardada = false"></textarea>
                                                                </div>

                                                                <div class="row mt-2">
                                                                    <div class="col-auto">
                                                                        <!-- Llama al método que limpia y resetea el flag -->
                                                                        <button class="btn btn-secondary me-2"
                                                                            type="button"
                                                                            (click)="clearCadenaForBase(base)">
                                                                            <i class="fa-solid fa-eraser"></i>&nbsp;
                                                                            Limpiar
                                                                        </button>
                                                                    </div>
                                                                    <div class="col text-end">
                                                                        <!-- Reaparecerá tras limpiar -->
                                                                        <button class="btn btn-success" type="button"
                                                                            *ngIf="!base.cadenaGuardada"
                                                                            (click)="saveCadenaForBase(base)">
                                                                            <i
                                                                                class="fa-solid fa-paper-plane"></i>&nbsp;
                                                                            Guardar cadena
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de Criterios de selección -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseSeven" aria-expanded="false"
                                                        aria-controls="flush-collapseSeven"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-stack me-2"></i>
                                                                7.- Criterios de selección
                                                                <span *ngIf="criteriosGuardados" class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showSelectionHelp = true"
                                                                (mouseleave)="showSelectionHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showSelectionHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí defines tus criterios de inclusión y
                                                                        exclusión: especifica las reglas que
                                                                        determinarán qué estudios serán considerados
                                                                        válidos o descartados en tu revisión.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>

                                                <div id="flush-collapseSeven" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample">
                                                    <div class="accordion-body">
                                                        <!-- Contenedor principal -->
                                                        <div class="d-flex justify-content-end">
                                                            <!-- Botón de Sugerencia IA en la fila superior -->
                                                            <button class="btn btn-info" type="button"
                                                                (click)="generateCriteriaFromAI()">
                                                                <i class="bi bi-robot"></i>&nbsp; Generar criterios
                                                                con IA
                                                            </button>
                                                        </div>
                                                        <!-- Contenido principal debajo, en una nueva fila -->
                                                        <div class="mt-3">
                                                            <div class="container">
                                                                <div class="row">
                                                                    <!-- Inclusiones -->
                                                                    <div class="col">
                                                                        <div class="container mt-4">
                                                                            <h2>Criterios de inclusión</h2>
                                                                            <div class="input-group mb-3">
                                                                                <textarea type="text"
                                                                                    class="form-control"
                                                                                    placeholder="Ingrese un elemento para incluir"
                                                                                    [(ngModel)]="inclusionValue"
                                                                                    name="inclusionValue"></textarea>
                                                                                <button type="button"
                                                                                    class="btn btn-primary"
                                                                                    (click)="addInclusion()">
                                                                                    <i
                                                                                        class="bi bi-arrow-bar-down"></i>&nbsp;
                                                                                    Añadir
                                                                                </button>
                                                                            </div>

                                                                            <table class="table table-bordered">
                                                                                <colgroup>
                                                                                    <col style="width: 80%;">
                                                                                    <col style="width: 20%;">
                                                                                </colgroup>
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th class="text-center">
                                                                                            Incluidos</th>
                                                                                        <th class="text-center">Acción
                                                                                        </th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    <tr
                                                                                        *ngFor="let crit of inclusions; let i = index">
                                                                                        <td>
                                                                                            <div
                                                                                                *ngIf="!crit.isEditing; else editIncl">
                                                                                                {{ crit.descripcion }}
                                                                                            </div>
                                                                                            <ng-template #editIncl>
                                                                                                <textarea
                                                                                                    class="form-control"
                                                                                                    [(ngModel)]="crit.descripcion"></textarea>
                                                                                            </ng-template>
                                                                                        </td>
                                                                                        <td class="text-center">
                                                                                            <!-- Botón Editar / Actualizar -->
                                                                                            <button
                                                                                                *ngIf="!crit.isEditing"
                                                                                                class="btn btn-sm btn-warning me-1"
                                                                                                (click)="editInclusion(i)">
                                                                                                <i
                                                                                                    class="bi bi-pencil-fill"></i>
                                                                                            </button>
                                                                                            <button
                                                                                                *ngIf="crit.isEditing"
                                                                                                class="btn btn-sm btn-success me-1"
                                                                                                (click)="updateInclusion(i)">
                                                                                                <i
                                                                                                    class="bi bi-save"></i>
                                                                                            </button>

                                                                                            <!-- Botón Eliminar -->
                                                                                            <button
                                                                                                class="btn btn-danger btn-sm"
                                                                                                (click)="removeInclusion(i)">
                                                                                                X
                                                                                            </button>
                                                                                        </td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>


                                                                    <!-- Exclusiones -->
                                                                    <div class="col">
                                                                        <div class="container mt-4">
                                                                            <h2>Criterios de exclusión</h2>
                                                                            <div class="input-group mb-3">
                                                                                <textarea type="text"
                                                                                    class="form-control"
                                                                                    placeholder="Ingrese un elemento para excluir"
                                                                                    [(ngModel)]="exclusionValue"
                                                                                    name="exclusionValue"></textarea>
                                                                                <button type="button"
                                                                                    class="btn btn-primary"
                                                                                    (click)="addExclusion()">
                                                                                    <i
                                                                                        class="bi bi-arrow-bar-down"></i>&nbsp;
                                                                                    Añadir
                                                                                </button>
                                                                            </div>

                                                                            <table class="table table-bordered">
                                                                                <colgroup>
                                                                                    <col style="width: 80%;">
                                                                                    <col style="width: 20%;">
                                                                                </colgroup>
                                                                                <thead>
                                                                                    <tr>
                                                                                        <th class="text-center">
                                                                                            Excluidos</th>
                                                                                        <th class="text-center">Acción
                                                                                        </th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    <tr
                                                                                        *ngFor="let crit of exclusions; let i = index">
                                                                                        <td>
                                                                                            <div
                                                                                                *ngIf="!crit.isEditing; else editExcl">
                                                                                                {{ crit.descripcion }}
                                                                                            </div>
                                                                                            <ng-template #editExcl>
                                                                                                <textarea
                                                                                                    class="form-control"
                                                                                                    [(ngModel)]="crit.descripcion"></textarea>
                                                                                            </ng-template>
                                                                                        </td>
                                                                                        <td class="text-center">
                                                                                            <!-- Botón Editar / Actualizar -->
                                                                                            <button
                                                                                                *ngIf="!crit.isEditing"
                                                                                                class="btn btn-sm btn-warning me-1"
                                                                                                (click)="editExclusion(i)">
                                                                                                <i
                                                                                                    class="bi bi-pencil-fill"></i>
                                                                                            </button>
                                                                                            <button
                                                                                                *ngIf="crit.isEditing"
                                                                                                class="btn btn-sm btn-success me-1"
                                                                                                (click)="updateExclusion(i)">
                                                                                                <i
                                                                                                    class="bi bi-save"></i>
                                                                                            </button>

                                                                                            <!-- Botón Eliminar -->
                                                                                            <button
                                                                                                class="btn btn-danger btn-sm"
                                                                                                (click)="removeExclusion(i)">
                                                                                                <i class="bi bi-x"></i>
                                                                                            </button>
                                                                                        </td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contenido Página 2 -->
                                    <div class="tab-pane fade" id="pagina2" role="tabpanel" aria-labelledby="tab2">
                                        <!-- Tarjeta de Preguntas -->

                                        <p>
                                            En esta sección podrás crear las preguntas que permitirán evaluar en detalle
                                            los artículos aceptados. Con estas preguntas analizarás la relevancia, la
                                            calidad metodológica, los resultados y las contribuciones de cada estudio,
                                            asegurando así un análisis sólido y consistente de tu revisión.
                                        </p>

                                        <div class="accordion accordion-flush" id="accordionFlushExample1">
                                            <!-- Acordeón de Preguntas de evaluación de calidad -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseEight" aria-expanded="false"
                                                        aria-controls="flush-collapseEight"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-question-circle me-2"></i>
                                                                8.- Preguntas de evaluación de calidad
                                                                <span *ngIf="qualityQuestionsSaved" class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showQualityHelp = true"
                                                                (mouseleave)="showQualityHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showQualityHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí defines las preguntas que utilizarás para
                                                                        evaluar la calidad metodológica de los estudios
                                                                        incluidos, por ejemplo rigurosidad, validez y
                                                                        aplicabilidad.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>
                                                <div id="flush-collapseEight" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample1">
                                                    <div class="accordion-body">
                                                        <!-- Botones para agregar y generar sugerencia -->
                                                        <div class="d-flex justify-content-between mb-3">
                                                            <button class="btn btn-primary" (click)="addQuestion1()">
                                                                <i class="bi bi-plus-circle"></i> Añadir pregunta
                                                            </button>
                                                            <button class="btn btn-info"
                                                                (click)="generateQualityQuestions()">
                                                                <i class="bi bi-robot"></i> Generar sugerencia con IA
                                                            </button>
                                                        </div>

                                                        <!-- Tabla de preguntas -->
                                                        <table class="table table-bordered">
                                                            <colgroup>
                                                                <col style="width: 70%;">
                                                                <col style="width: 30%;">
                                                            </colgroup>
                                                            <thead>
                                                                <tr>
                                                                    <th>Pregunta</th>
                                                                    <th class="text-center">Acciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr *ngFor="let question of questions1; let i = index">
                                                                    <td>
                                                                        <ng-container
                                                                            *ngIf="!question.isEditing; else editInput">
                                                                            {{ question.descripcion }}
                                                                        </ng-container>
                                                                        <ng-template #editInput>
                                                                            <textarea class="form-control" rows="2"
                                                                                [(ngModel)]="question.descripcion"></textarea>
                                                                        </ng-template>
                                                                    </td>
                                                                    <td class="text-center">
                                                                        <ng-container
                                                                            *ngIf="!question.isEditing; else saveButton">
                                                                            <button class="btn btn-warning btn-sm me-2"
                                                                                (click)="editQuestion1(i)">
                                                                                <i class="bi bi-pencil-square"></i>
                                                                                Editar
                                                                            </button>
                                                                        </ng-container>
                                                                        <ng-template #saveButton>
                                                                            <button class="btn btn-success btn-sm me-2"
                                                                                (click)="saveQuestion1(i)">
                                                                                <i class="bi bi-save"></i> Guardar
                                                                            </button>
                                                                        </ng-template>
                                                                        <button class="btn btn-danger btn-sm"
                                                                            (click)="deleteQuestion1(i)">
                                                                            <i class="bi bi-trash"></i> Eliminar
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de Respuestas de evaluación -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseNine" aria-expanded="false"
                                                        aria-controls="flush-collapseNine"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-check-circle me-2"></i>
                                                                9.- Respuestas de evaluación
                                                                <span *ngIf="respuestasGuardadas" class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showAnswersHelp = true"
                                                                (mouseleave)="showAnswersHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showAnswersHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí añades o editas cada posible respuesta para
                                                                        tus criterios de evaluación, asignando
                                                                        descripción y un peso relativo antes de guardar.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>

                                                <div id="flush-collapseNine" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample1">
                                                    <div class="accordion-body">
                                                        <!-- Botón para crear una fila nueva en modo edición -->
                                                        <button class="btn btn-primary mb-3" (click)="addLocalAnswer()">
                                                            <i class="bi bi-plus-circle"></i> Añadir respuesta
                                                        </button>

                                                        <table class="table table-bordered">
                                                            <colgroup>
                                                                <col style="width: 55%;">
                                                                <col style="width: 15%;">
                                                                <col style="width: 30%;">
                                                            </colgroup>
                                                            <thead>
                                                                <tr>
                                                                    <th>Descripción</th>
                                                                    <th class="text-center">Peso</th>
                                                                    <th class="text-center">Acción</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr *ngFor="let answer1 of answers1; let i = index">
                                                                    <!-- Columna Descripción -->
                                                                    <td>
                                                                        <!-- Si está en edición, muestra un input; si no, muestra el texto -->
                                                                        <ng-container
                                                                            *ngIf="answer1.isEditing; else showDesc">
                                                                            <input type="text"
                                                                                class="form-control form-control-sm"
                                                                                [(ngModel)]="answer1.descripcion" />
                                                                        </ng-container>
                                                                        <ng-template #showDesc>
                                                                            {{ answer1.descripcion }}
                                                                        </ng-template>
                                                                    </td>

                                                                    <!-- Columna Peso -->
                                                                    <td>
                                                                        <!-- Si está en edición => input editable, de lo contrario input readOnly -->
                                                                        <input type="number"
                                                                            class="form-control form-control-sm"
                                                                            [(ngModel)]="answer1.peso"
                                                                            [readonly]="!answer1.isEditing" />
                                                                    </td>

                                                                    <!-- Columna Acción -->
                                                                    <td class="text-center">
                                                                        <!-- CASO 1: Fila en modo edición, y no tiene ID => Botón verde "Guardar" para nueva respuesta -->
                                                                        <button
                                                                            *ngIf="answer1.isEditing && !answer1.id_respuesta"
                                                                            class="btn btn-success btn-sm me-2"
                                                                            (click)="saveNewAnswer(i)">
                                                                            <i class="bi bi-check-square"></i> Guardar
                                                                        </button>

                                                                        <!-- CASO 2: Fila en modo edición, pero ya existe (id_respuesta) => Botón verde "Guardar" para update -->
                                                                        <button
                                                                            *ngIf="answer1.isEditing && answer1.id_respuesta"
                                                                            class="btn btn-success btn-sm me-2"
                                                                            (click)="updateAnswer1(i)">
                                                                            <i class="bi bi-check-square"></i>
                                                                            Actualizar
                                                                        </button>

                                                                        <!-- CASO 3: Fila sin edición => Botón amarillo "Editar" -->
                                                                        <button *ngIf="!answer1.isEditing"
                                                                            class="btn btn-warning btn-sm me-2"
                                                                            (click)="editAnswer1(i)">
                                                                            <i class="bi bi-pencil-square"></i> Editar
                                                                        </button>

                                                                        <!-- Botón Eliminar en todos los casos -->
                                                                        <button class="btn btn-danger btn-sm"
                                                                            (click)="deleteAnswer1(i)">
                                                                            <i class="bi bi-trash"></i> Eliminar
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Acordeón de Puntuaciones de evaluación de calidad -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed d-flex align-items-center"
                                                        type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#flush-collapseTen" aria-expanded="false"
                                                        aria-controls="flush-collapseTen"
                                                        style="background-color: #F8F8F8; flex: 7;">
                                                        <div class="d-flex align-items-center w-100">
                                                            <!-- Título con icono y check -->
                                                            <h5
                                                                class="card-title mb-0 fw-bold d-flex align-items-center">
                                                                <i class="bi bi-bar-chart me-2"></i>
                                                                10.- Puntuaciones de evaluación de calidad
                                                                <span *ngIf="puntuacionesGuardadas" class="ms-2">
                                                                    <i class="bi bi-check-circle-fill text-success"></i>
                                                                </span>
                                                            </h5>

                                                            <!-- Tooltip de ayuda -->
                                                            <span class="tooltip-container ms-2"
                                                                (mouseenter)="showScoresHelp = true"
                                                                (mouseleave)="showScoresHelp = false">
                                                                <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                                <div *ngIf="showScoresHelp"
                                                                    class="tooltip-content animate__animated animate__fadeIn">
                                                                    <p class="mb-0 fw-normal">
                                                                        Aquí se muestra la puntuación máxima calculada y
                                                                        puedes establecer la puntuación mínima de
                                                                        aceptación. Guarda el límite para filtrar los
                                                                        estudios según su calidad.
                                                                    </p>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </button>
                                                </h2>
                                                <div id="flush-collapseTen" class="accordion-collapse collapse"
                                                    data-bs-parent="#accordionFlushExample1">
                                                    <div class="accordion-body">
                                                        <div class="row mb-3">
                                                            <!-- Puntuación Máxima -->
                                                            <div class="col-md-6 mb-3">
                                                                <label for="maxScore" class="form-label">
                                                                    <strong>
                                                                        Puntuación
                                                                        máxima</strong></label>
                                                                <!-- Se usa [value]="getMaxScore()" para mostrar la puntuación calculada -->
                                                                <input type="number" id="maxScore" class="form-control"
                                                                    [value]="getMaxScore()" readonly />
                                                            </div>

                                                            <!-- Puntuación Límite -->
                                                            <div class="col-md-6 mb-3">
                                                                <label for="limitScore"
                                                                    class="form-label"><strong>Puntuación
                                                                        mínima de aceptación</strong></label>
                                                                <div class="input-group">
                                                                    <input type="number" id="limitScore"
                                                                        class="form-control" [(ngModel)]="limitScore1"
                                                                        (ngModelChange)="onLimitScoreChange($event)" />
                                                                    <!-- Botón "Guardar" solo aparece si puntuacionesGuardadas es true -->
                                                                    <button class="btn btn-success"
                                                                        (click)="saveLimitScore()"
                                                                        *ngIf="!puntuacionesGuardadas">
                                                                        Guardar
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <!-- Contenido Página 3 -->
                                    <div class="tab-pane fade" id="pagina3" role="tabpanel" aria-labelledby="tab3">

                                        <p>
                                            En esta sección podrás ingresar las preguntas para hacer la recolección de
                                            datos en el submenú "Extracción de datos" donde estaran los estudios
                                            aceptados. De esta
                                            forma, podrás definir cada campo de información que deseas extraer.
                                        </p>
                                        <div class="container">
                                            <div class="card">
                                                <div class="card-header d-flex align-items-center">
                                                    <h5 class="mb-0 fw-bold d-flex align-items-center">
                                                        <i class="bi bi-clipboard-data-fill me-2"></i>
                                                        11.- Formulario de extracción de datos
                                                        <span *ngIf="fieldsSaved" class="ms-2">
                                                            <i class="bi bi-check-circle-fill text-success"></i>
                                                        </span>

                                                        <!-- Tooltip de ayuda -->
                                                        <span class="tooltip-container ms-3"
                                                            (mouseenter)="showExtractionHelp = true"
                                                            (mouseleave)="showExtractionHelp = false">
                                                            <i class="fa-solid fa-circle-question tooltip-icon"></i>
                                                            <div *ngIf="showExtractionHelp"
                                                                class="tooltip-content animate__animated animate__fadeIn">
                                                                <p class="mb-0 fw-normal">
                                                                    Aquí defines los campos que quieres extraer de cada
                                                                    estudio. Añade una descripción clara y selecciona el
                                                                    tipo de dato (texto, numérico, fecha…) para cada
                                                                    campo antes de guardar.
                                                                </p>
                                                            </div>
                                                        </span>
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <!-- Contenedor principal -->
                                                    <div class="d-flex justify-content-between">
                                                        <!-- Botón para agregar un nuevo campo -->
                                                        <button class="btn btn-primary" (click)="addField()">
                                                            + Agregar Campo
                                                        </button>
                                                        <!-- Botón de Sugerencia IA en la fila superior -->
                                                        <button class="btn btn-info align-self-start" type="button"
                                                            (click)="onGenerateQuestions()">
                                                            <i class="bi bi-robot"></i>&nbsp; Generar las preguntas con
                                                            IA
                                                        </button>
                                                    </div>
                                                    <!-- Envolver la tabla en un contenedor responsive -->
                                                    <div class="table-responsive mt-3">
                                                        <table class="table table-bordered">
                                                            <colgroup>
                                                                <col style="width: 10%;">
                                                                <col style="width: 60%;">
                                                                <col style="width: 10%;">
                                                                <col style="width: 20%;">
                                                            </colgroup>
                                                            <thead>
                                                                <tr>
                                                                    <th class="text-center">Orden</th>
                                                                    <th>Descripción</th>
                                                                    <th class="text-center">Tipo</th>
                                                                    <th class="text-center">Acciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr *ngFor="let field of fields; let i = index">
                                                                    <td>
                                                                        <div class="d-flex">
                                                                            <button
                                                                                class="btn btn-secondary btn-sm w-50 me-1"
                                                                                (click)="moveUp(i)">
                                                                                <strong>↑</strong>
                                                                            </button>
                                                                            <button
                                                                                class="btn btn-secondary btn-sm w-50"
                                                                                (click)="moveDown(i)">
                                                                                <strong>↓</strong>
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                    <!-- Columna de Descripción -->
                                                                    <td>
                                                                        <!-- Modo edición -->
                                                                        <ng-container
                                                                            *ngIf="field.isEditing; else viewDescription">
                                                                            <textarea type="text" class="form-control"
                                                                                [(ngModel)]="field.descripcion"
                                                                                placeholder="Descripción"></textarea>
                                                                        </ng-container>
                                                                        <!-- Modo vista -->
                                                                        <ng-template #viewDescription>
                                                                            {{ field.descripcion }}
                                                                        </ng-template>
                                                                    </td>
                                                                    <!-- Columna de Tipo -->
                                                                    <td class="text-center">
                                                                        <!-- Modo edición -->
                                                                        <ng-container
                                                                            *ngIf="field.isEditing; else viewType">
                                                                            <select class="form-select"
                                                                                [(ngModel)]="field.tipo">
                                                                                <option value="Booleano">Booleano
                                                                                </option>
                                                                                <option value="Texto">Texto</option>
                                                                                <option value="Decimal">Decimal</option>
                                                                                <option value="Entero">Entero</option>
                                                                                <option value="Fecha">Fecha</option>
                                                                            </select>
                                                                        </ng-container>
                                                                        <!-- Modo vista -->
                                                                        <ng-template #viewType>
                                                                            {{ field.tipo }}
                                                                        </ng-template>
                                                                    </td>
                                                                    <!-- Columna de Acciones -->
                                                                    <td class="text-center">
                                                                        <!-- Si está en edición: mostrar Guardar/Cancelar -->
                                                                        <ng-container
                                                                            *ngIf="field.isEditing; else normalActions">
                                                                            <button class="btn btn-success btn-sm me-1"
                                                                                (click)="saveField(i)">
                                                                                Guardar
                                                                            </button>
                                                                            <button class="btn btn-secondary btn-sm"
                                                                                (click)="cancelEdit(i)">
                                                                                Cancelar
                                                                            </button>
                                                                        </ng-container>
                                                                        <!-- Si NO está en edición: mostrar Editar/Eliminar -->
                                                                        <ng-template #normalActions>
                                                                            <button class="btn btn-warning btn-sm me-1"
                                                                                (click)="editField(i)">
                                                                                Editar
                                                                            </button>
                                                                            <button class="btn btn-danger btn-sm"
                                                                                (click)="removeField(i)">
                                                                                Eliminar
                                                                            </button>
                                                                        </ng-template>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>